<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 800px;
        width: 100%;
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }

    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .mode-toggle {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
    }

    .mode-badge {
        background: rgba(255,255,255,0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .call-screen {
        padding: 40px;
        text-align: center;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .call-screen.hidden {
        display: none;
    }

    .call-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .call-screen h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
    }

    .call-screen p {
        color: #6c757d;
        margin-bottom: 30px;
        font-size: 16px;
    }

    .phone-input-group {
        display: flex;
        gap: 10px;
        max-width: 400px;
        width: 100%;
        margin-bottom: 20px;
    }

    .phone-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e9ecef;
        border-radius: 30px;
        font-size: 16px;
        outline: none;
        transition: all 0.3s;
    }

    .phone-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-call {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-call:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-call:active {
        transform: translateY(0);
    }

    .calling-animation {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .calling-animation.active {
        display: flex;
    }

    .call-pulse {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        animation: callPulse 2s infinite;
        position: relative;
    }

    @keyframes callPulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        50% {
            box-shadow: 0 0 0 30px rgba(16, 185, 129, 0);
        }
    }

    .calling-text {
        font-size: 18px;
        color: #333;
        font-weight: 600;
    }

    .calling-number {
        color: #6c757d;
        font-size: 16px;
    }

    .btn-end-call {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s;
    }

    .btn-end-call:hover {
        background: #dc2626;
        transform: translateY(-2px);
    }

    .chat-section {
        display: none;
    }

    .chat-section.active {
        display: block;
    }

    .call-info {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .call-info-text {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #059669;
        font-weight: 600;
    }

    .call-status {
        font-size: 12px;
        color: #059669;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: blink 1.5s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .btn-disconnect {
        background: white;
        border: 2px solid #ef4444;
        color: #ef4444;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-disconnect:hover {
        background: #ef4444;
        color: white;
    }

    .chat-container {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        line-height: 1.5;
    }

    .message.ai .message-content {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 10px;
        flex-shrink: 0;
    }

    .message.ai .avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .message.user .avatar {
        background: #e9ecef;
        color: #667eea;
    }

    .controls {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
    }

    .input-area {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    #userInput {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.3s;
    }

    #userInput:focus {
        border-color: #667eea;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-voice {
        background: #fff;
        color: #667eea;
        border: 2px solid #667eea;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 24px;
    }

    .btn-voice:hover {
        background: #667eea;
        color: white;
    }

    .btn-voice.listening {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
    }

    .status {
        text-align: center;
        color: #6c757d;
        font-size: 14px;
        margin-top: 10px;
        min-height: 20px;
    }

    .status.active {
        color: #667eea;
        font-weight: 600;
    }

    .typing-indicator {
        display: none;
        padding: 10px;
    }

    .typing-indicator.active {
        display: flex;
    }

    .typing-indicator span {
        height: 10px;
        width: 10px;
        background: #667eea;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    .error-message {
        color: #ef4444;
        font-size: 14px;
        margin-top: 10px;
        display: none;
    }

    .error-message.show {
        display: block;
    }

    /* enable-voice button removed ‚Äî autoplay handled silently */
</style>


</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• AI  Assistant</h1>
            <p>Chat with your AI assistant</p>
            <div class="mode-toggle">
                <span class="mode-badge" id="modeBadge">ü§ñ AI Mode</span>
            </div>
        </div>

        <!-- Enable-voice removed: autoplay attempts are performed silently on load -->


    <!-- Call screen removed so users go straight to chat -->

    <!-- Chat Section -->
    <div class="chat-section" id="chatSection">

        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="avatar">AI</div>
                <div class="message-content">
                    Hello! I'm your AI assistant. I can help answer general questions I'll remember our conversation! How can I help you today?
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="avatar">AI</div>
                <div class="message-content">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="input-area">
                <input type="text" id="userInput" placeholder="Type your health question..." />
                <button class="btn btn-primary" id="sendBtn">Send</button>
            </div>
            <button class="btn-voice" id="voiceBtn" title="Click to speak">üé§</button>
            <div class="status" id="status"></div>
        </div>
    </div>
</div>

<script>
    const callScreen = document.getElementById('callScreen');
    const chatSection = document.getElementById('chatSection');
    const phoneInput = document.getElementById('phoneInput');
    const callBtn = document.getElementById('callBtn');
    const callingAnimation = document.getElementById('callingAnimation');
    const displayNumber = document.getElementById('displayNumber');
    const cancelCallBtn = document.getElementById('cancelCallBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const errorMessage = document.getElementById('errorMessage');
    
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const status = document.getElementById('status');
    const typingIndicator = document.getElementById('typingIndicator');
    const modeBadge = document.getElementById('modeBadge');

    let conversationHistory = [];
    let isListening = false;
    let recognition;
    let synthesis = window.speechSynthesis;
    let useRealAPI = true;
    // Set your OpenAI API key directly in this file (do NOT commit it to public repos).
    // Example: const OPENAI_API_KEY = 'sk-xxx...';
    const OPENAI_API_KEY = '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';
    let openaiApiKey = OPENAI_API_KEY;
    const systemInstruction = "You are a general Ai that knows everything about everything.";
    const WELCOME_MSG = "Hello! I'm your AI health assistant. How can I help you today?";
    let userPhoneNumber = '';

    // Health knowledge base for demo mode
    const healthResponses = {
        'headache': 'Headaches can have many causes including stress, dehydration, lack of sleep, or tension. For mild headaches, try drinking water, resting in a quiet dark room, and using over-the-counter pain relievers as directed. If headaches are severe, frequent, or accompanied by other symptoms, please consult a healthcare provider.',
        
        'fever': 'A fever is usually a sign that your body is fighting an infection. For adults, a fever is generally considered 100.4¬∞F (38¬∞C) or higher. Stay hydrated, rest, and you can use fever-reducing medications like acetaminophen or ibuprofen. Seek medical attention if fever is very high (above 103¬∞F), lasts more than 3 days, or is accompanied by severe symptoms.',
        
        'cold': 'Common cold symptoms include runny nose, sore throat, cough, and congestion. Get plenty of rest, stay hydrated, use a humidifier, and gargle with warm salt water for sore throat. Most colds resolve on their own in 7-10 days. If symptoms worsen or persist beyond 10 days, consult a doctor.',
        
        'cough': 'Coughs can be caused by colds, allergies, or irritants. Drink plenty of fluids, use honey (for adults and children over 1 year), and try a humidifier. See a doctor if the cough lasts more than 3 weeks, produces blood, or is accompanied by high fever or difficulty breathing.',
        
        'stomach': 'Stomach aches can result from indigestion, gas, stress, or infections. Try eating bland foods (BRAT diet: bananas, rice, applesauce, toast), stay hydrated, and avoid spicy or fatty foods. Seek medical care if pain is severe, persistent, or accompanied by vomiting, fever, or blood in stool.',
        
        'sleep': 'Good sleep hygiene includes: maintaining a consistent sleep schedule, creating a relaxing bedtime routine, keeping your bedroom cool and dark, avoiding screens before bed, limiting caffeine and alcohol, and getting regular exercise (but not close to bedtime). Most adults need 7-9 hours of sleep per night.',
        
        'stress': 'Managing stress is important for overall health. Effective strategies include: regular exercise, meditation or deep breathing, adequate sleep, talking to friends or a therapist, time management, hobbies, and limiting caffeine. If stress is overwhelming or affecting daily life, consider speaking with a mental health professional.',
        
        'diet': 'A healthy diet includes: plenty of fruits and vegetables, whole grains, lean proteins, healthy fats, and adequate water. Limit processed foods, added sugars, and excessive salt. Try to eat a variety of colorful foods and practice portion control. Everyone\'s nutritional needs are different, so consider consulting a registered dietitian.',
        
        'exercise': 'The CDC recommends at least 150 minutes of moderate-intensity aerobic activity per week, plus muscle-strengthening activities twice weekly. Start slowly if you\'re new to exercise, choose activities you enjoy, and stay consistent. Always consult your doctor before starting a new exercise program, especially if you have health conditions.',
        
        'default': 'I understand you have a health concern. While I can provide general health information, I\'m not a doctor and cannot diagnose conditions. For personalized medical advice, please consult with a qualified healthcare provider. Is there a specific health topic you\'d like general information about, such as nutrition, exercise, sleep, or common symptoms?'
    };

    // Attach call-related listeners only if those elements exist (call-screen was removed)
    if (callBtn) callBtn.addEventListener('click', initiateCall);

    if (phoneInput) {
        phoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') initiateCall();
        });
    }

    if (cancelCallBtn) {
        cancelCallBtn.addEventListener('click', () => {
            if (callingAnimation) callingAnimation.classList.remove('active');
            if (callBtn) callBtn.style.display = 'flex';
            if (phoneInput) phoneInput.disabled = false;
        });
    }

    const connectedNumber = document.getElementById('connectedNumber');
    
    // Disconnect button (only if present)
    if (disconnectBtn) {
        disconnectBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to end this call?')) {
                endCall();
            }
        });
    }

    function validatePhoneNumber(phone) {
        // Basic phone validation - accepts various formats
        const cleaned = phone.replace(/\D/g, '');
        return cleaned.length >= 10 && cleaned.length <= 15;
    }

    function initiateCall() {
        // Allow users to proceed without entering a phone number.
        const phone = phoneInput.value.trim();

        if (phone && !validatePhoneNumber(phone)) {
            // If a phone was provided but is invalid, show an error briefly.
            errorMessage.classList.add('show');
            phoneInput.style.borderColor = '#ef4444';
            setTimeout(() => {
                errorMessage.classList.remove('show');
                phoneInput.style.borderColor = '#e9ecef';
            }, 3000);
            return;
        }

        // If no phone provided, set a placeholder identifier.
        userPhoneNumber = phone || 'Guest';
        if (displayNumber) displayNumber.textContent = userPhoneNumber;

        // Show calling animation (kept for UX) and proceed to chat.
        callBtn.style.display = 'none';
        phoneInput.disabled = true;
        callingAnimation.classList.add('active');

        // Short delay to simulate connecting, then open chat.
        setTimeout(() => {
            connectCall();
        }, 800);
    }

    function connectCall() {
        if (callScreen) callScreen.classList.add('hidden');
        if (chatSection) chatSection.classList.add('active');

        // Auto-speak welcome message
        speakText(WELCOME_MSG);
    }

    function endCall() {
        // Stop any ongoing speech
        synthesis.cancel();
        
        // Reset to call screen if present; otherwise ensure chat is hidden and inputs reset safely
        if (chatSection) chatSection.classList.remove('active');
        if (callScreen) callScreen.classList.remove('hidden');
        if (callingAnimation) callingAnimation.classList.remove('active');
        if (callBtn) callBtn.style.display = 'flex';
        if (phoneInput) {
            phoneInput.disabled = false;
            phoneInput.value = '';
        }
        
        // Clear chat history
        conversationHistory = [];
        const messages = chatContainer.querySelectorAll('.message:not(.ai):first-child');
        messages.forEach(msg => {
            if (!msg.classList.contains('ai') || msg !== chatContainer.querySelector('.message.ai')) {
                msg.remove();
            }
        });
    }

    // Initialize speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isListening = true;
            voiceBtn.classList.add('listening');
            status.textContent = 'Listening... Speak now';
            status.classList.add('active');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userInput.value = transcript;
            sendMessage();
        };

        recognition.onerror = (event) => {
            let errorMsg = '';
            if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                errorMsg = 'Microphone access denied. Please allow microphone permissions in your browser settings.';
            } else if (event.error === 'no-speech') {
                errorMsg = 'No speech detected. Please try again.';
            } else {
                errorMsg = 'Speech error: ' + event.error;
            }
            status.textContent = errorMsg;
            status.classList.remove('active');
            isListening = false;
            voiceBtn.classList.remove('listening');
            
            setTimeout(() => {
                status.textContent = '';
            }, 5000);
        };

        recognition.onend = () => {
            isListening = false;
            voiceBtn.classList.remove('listening');
            status.textContent = '';
            status.classList.remove('active');
        };
    }

    // Voice button click
    voiceBtn.addEventListener('click', async () => {
        if (!recognition) {
            status.textContent = 'Voice recognition not supported in this browser. Try Chrome or Edge.';
            setTimeout(() => status.textContent = '', 5000);
            return;
        }

        if (isListening) {
            recognition.stop();
        } else {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                recognition.start();
            } catch (err) {
                status.textContent = 'Please allow microphone access to use voice input.';
                setTimeout(() => status.textContent = '', 5000);
            }
        }
    });

    // Send button click
    sendBtn.addEventListener('click', sendMessage);

    function updateModeBadge(){
        if (openaiApiKey && useRealAPI) modeBadge.textContent = 'üü¢ OpenAI Mode';
        else modeBadge.textContent = 'üìö Demo Mode';
    }
    updateModeBadge();
    // Helper: try to play speech and detect whether it actually started (autoplay may be blocked)
    function tryAutoSpeak(text, timeout = 2000) {
        return new Promise((resolve, reject) => {
            if (!window.speechSynthesis) return reject(new Error('Speech synthesis not available'));
            try {
                // Ensure voices are loaded; some browsers require voices to be ready
                function ensureVoicesLoaded() {
                    return new Promise((res) => {
                        const voices = window.speechSynthesis.getVoices();
                        if (voices && voices.length) return res(true);
                        // wait for voiceschanged or timeout
                        const onVoices = () => {
                            window.speechSynthesis.removeEventListener('voiceschanged', onVoices);
                            res(true);
                        };
                        window.speechSynthesis.addEventListener('voiceschanged', onVoices);
                        setTimeout(() => {
                            window.speechSynthesis.removeEventListener('voiceschanged', onVoices);
                            res(false);
                        }, 1000);
                    });
                }

                ensureVoicesLoaded().then(() => {
                    const utter = new SpeechSynthesisUtterance(text);
                    let started = false;
                    utter.onstart = () => {
                        started = true;
                        resolve(true);
                    };
                    utter.onerror = (e) => reject(e);
                    // Cancel any prior speech to avoid queuing issues
                    try { window.speechSynthesis.cancel(); } catch (e) {}
                    window.speechSynthesis.speak(utter);
                    setTimeout(() => {
                        if (!started) reject(new Error('autoplay-blocked'));
                    }, timeout);
                }).catch(reject);
            } catch (err) {
                reject(err);
            }
        });
    }

    // Try auto-speak several times to improve reliability on reloads
    async function speakWithRetries(text, attempts = 3, delayMs = 500) {
        for (let i = 0; i < attempts; i++) {
            try {
                await tryAutoSpeak(text, 2000);
                return true;
            } catch (err) {
                // last attempt -> return false
                if (i === attempts - 1) {
                    console.warn('Auto-speak failed after retries:', err);
                    return false;
                }
                // small backoff before retrying
                await new Promise(r => setTimeout(r, delayMs));
            }
        }
        return false;
    }

    // Show chat directly on page load (skip call screen) and speak intro; if blocked, show enable button
    document.addEventListener('DOMContentLoaded', async () => {
        userPhoneNumber = userPhoneNumber || 'Guest';
        if (callScreen) callScreen.classList.add('hidden');
        if (chatSection) chatSection.classList.add('active');

        // Attempt to auto-speak on load; do not display any enable button.
        try {
            await speakWithRetries(WELCOME_MSG, 4, 600);
        } catch (err) {
            console.warn('Auto-speak failed on load:', err);
        }
    });

    // Enter key press
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        userInput.value = '';
        
        conversationHistory.push({ role: 'user', content: message });

        typingIndicator.classList.add('active');
        chatContainer.scrollTop = chatContainer.scrollHeight;

        let response = await getAIResponse(message);
        
        typingIndicator.classList.remove('active');
        
        if (response) {
            conversationHistory.push({ role: 'assistant', content: response });
            addMessage(response, 'ai');
            speakText(response);
        }
        
        userInput.focus();
    }

    async function getAIResponse(message) {
        // If there's an OpenAI API key and real API enabled, try calling OpenAI Chat API
        if (useRealAPI && openaiApiKey) {
            try {
                // Build messages array with a system instruction at the front
                const messages = [{ role: 'system', content: systemInstruction }, ...conversationHistory.map(m => ({ role: m.role, content: m.content }))];

                const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + openaiApiKey
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: messages,
                        max_tokens: 800,
                        temperature: 0.2
                    })
                });

                if (!resp.ok) {
                    console.error('OpenAI error', resp.status, await resp.text());
                    useRealAPI = false;
                    updateModeBadge();
                    return getDemoResponse(message);
                }

                const data = await resp.json();
                if (data && data.choices && data.choices.length > 0) {
                    const out = data.choices[0].message?.content || data.choices[0].text;
                    if (out) return out.trim();
                }
            } catch (err) {
                console.error('OpenAI request failed', err);
                useRealAPI = false;
                updateModeBadge();
            }
        }

        // Fallback to demo responses
        updateModeBadge();
        return getDemoResponse(message);
    }

    function getDemoResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        if (lowerMessage.includes('more') || lowerMessage.includes('tell me more') || lowerMessage.includes('what else')) {
            return 'I\'d be happy to provide more information! Could you specify which topic you\'d like to know more about? I can discuss symptoms, treatments, prevention, or related health topics.';
        }
        
        if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
            return 'You\'re welcome! Feel free to ask me any other health questions. I\'m here to help with information about symptoms, wellness, nutrition, exercise, and general health topics.';
        }
        
        for (const [keyword, response] of Object.entries(healthResponses)) {
            if (lowerMessage.includes(keyword)) {
                return response + '\n\nDo you have any follow-up questions about this or other health topics?';
            }
        }
        
        return healthResponses.default + '\n\nFeel free to ask as many questions as you need!';
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = sender === 'ai' ? 'AI' : 'You';
        
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = text;
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);
        
        chatContainer.insertBefore(messageDiv, typingIndicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function speakText(text) {
        synthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;

        utterance.onstart = () => {
            status.textContent = 'Speaking...';
            status.classList.add('active');
        };

        utterance.onend = () => {
            status.textContent = '';
            status.classList.remove('active');
        };

        synthesis.speak(utterance);
    }

    window.addEventListener('beforeunload', () => {
        synthesis.cancel();
    });
</script>


</body>
</html>